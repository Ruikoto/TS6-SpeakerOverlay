name: Publish Windows (Single EXE)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  PROJECT_PATH: "TS6-SpeakerOverlay/TS6-SpeakerOverlay.csproj"
  BINARY_NAME: "TS6-SpeakerOverlay"

jobs:
  build:
    name: Build ${{ matrix.rid }} (${{ matrix.self_contained == true && 'Full' || 'Lite' }})
    runs-on: windows-latest
    strategy:
      matrix:
        # 组合：架构 x 是否自包含
        rid: [win-x64, win-arm64]
        self_contained: [true, false] # true=大包(自带环境), false=小包(依赖环境)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 提取版本号
      - name: Get Version Name
        id: version
        run: |
          $ver = if ("${{ github.ref_type }}" -eq "tag") { "${{ github.ref_name }}" } else { "dev-build" }
          echo "VERSION_TAG=$ver" >> $env:GITHUB_OUTPUT

      # 2. 计算文件名后缀 (大包无后缀，小包加 -dependent)
      - name: Get File Suffix
        id: suffix
        run: |
          $suf = if ("${{ matrix.self_contained }}" -eq "true") { "" } else { "-dependent" }
          echo "FILE_SUFFIX=$suf" >> $env:GITHUB_OUTPUT

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish
        run: |
          # 只有自包含版本才启用 ReadyToRun (R2R会增加体积，对小包没必要)
          $r2r = "${{ matrix.self_contained }}"
          
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r ${{ matrix.rid }} `
            --self-contained ${{ matrix.self_contained }} `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:PublishReadyToRun=$r2r `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            -p:AssemblyName=${{ env.BINARY_NAME }} `
            -o ./publish_output

      # 3. 重命名并移动 (格式: Name-Version-Arch-Type.exe)
      - name: Rename and Move Executable
        run: |
          $src = "./publish_output/${{ env.BINARY_NAME }}.exe"
          $dest = "./${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION_TAG }}-${{ matrix.rid }}${{ steps.suffix.outputs.FILE_SUFFIX }}.exe"
          Move-Item -Path $src -Destination $dest

      # 4. 上传
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.rid }}${{ steps.suffix.outputs.FILE_SUFFIX }}
          path: ./*.exe

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/**/*.exe
          generate_release_notes: true