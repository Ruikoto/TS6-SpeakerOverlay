name: Publish Windows (Single EXE)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  PROJECT_PATH: "TS6-SpeakerOverlay/TS6-SpeakerOverlay.csproj"
  BINARY_NAME: "TS6-SpeakerOverlay"

jobs:
  build:
    name: Build ${{ matrix.rid }} (Single File)
    runs-on: windows-latest
    strategy:
      matrix:
        # 只构建 Windows x64 和 ARM64
        rid: [win-x64, win-arm64]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r ${{ matrix.rid }} `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:PublishReadyToRun=true `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            -p:AssemblyName=${{ env.BINARY_NAME }} `
            -o ./publish_output

      # 将生成的 exe 重命名（加上架构后缀）并移动到根目录
      # 例如：TS6-SpeakerOverlay.exe -> TS6-SpeakerOverlay-win-x64.exe
      - name: Rename and Move Executable
        run: |
          Move-Item -Path ./publish_output/${{ env.BINARY_NAME }}.exe -Destination ./${{ env.BINARY_NAME }}-${{ matrix.rid }}.exe

      # 直接上传 exe 文件，不打包 zip
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.rid }}
          path: ${{ env.BINARY_NAME }}-${{ matrix.rid }}.exe

  release:
    if: startsWith(github.ref, 'refs/tags/') # 仅在 tag 触发时才创建 Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # 自动抓取 artifacts 文件夹下所有的 exe 并发布
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/**/*.exe
          generate_release_notes: true