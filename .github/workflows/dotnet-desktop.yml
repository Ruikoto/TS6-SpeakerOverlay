name: Publish Windows (Single EXE)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  PROJECT_PATH: "TS6-SpeakerOverlay/TS6-SpeakerOverlay.csproj"
  BINARY_NAME: "TS6-SpeakerOverlay"

jobs:
  build:
    name: Build ${{ matrix.rid }} (${{ matrix.self_contained == true && 'Full' || 'Lite' }})
    runs-on: windows-latest
    strategy:
      matrix:
        rid: [win-x64, win-arm64]
        self_contained: [true, false]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version Name
        id: version
        run: |
          $ver = if ("${{ github.ref_type }}" -eq "tag") { "${{ github.ref_name }}" } else { "dev-build" }
          echo "VERSION_TAG=$ver" >> $env:GITHUB_OUTPUT

      - name: Get File Suffix
        id: suffix
        run: |
          $suf = if ("${{ matrix.self_contained }}" -eq "true") { "" } else { "-dependent" }
          echo "FILE_SUFFIX=$suf" >> $env:GITHUB_OUTPUT

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish
        run: |
          $r2r = "${{ matrix.self_contained }}"
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r ${{ matrix.rid }} `
            --self-contained ${{ matrix.self_contained }} `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:PublishReadyToRun=$r2r `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            -p:AssemblyName=${{ env.BINARY_NAME }} `
            -o ./publish_output

      - name: Rename and Move Executable
        run: |
          $src = "./publish_output/${{ env.BINARY_NAME }}.exe"
          $dest = "./${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION_TAG }}-${{ matrix.rid }}${{ steps.suffix.outputs.FILE_SUFFIX }}.exe"
          Move-Item -Path $src -Destination $dest

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.rid }}${{ steps.suffix.outputs.FILE_SUFFIX }}
          path: ./*.exe

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # ğŸ”¥ æ ¸å¿ƒæ­¥éª¤ï¼šç”Ÿæˆ release_note.md
      - name: Generate Release Notes
        run: |
          # 1. å®šä¹‰åŸºç¡€å˜é‡
          REPO="${{ github.repository }}"
          TAG="${{ github.ref_name }}"
          BASE_URL="https://github.com/$REPO/releases/download/$TAG"
          NAME="${{ env.BINARY_NAME }}"
          
          # 2. é¢„åˆ¤æ–‡ä»¶å (å¿…é¡»ä¸ build æ­¥éª¤çš„å‘½åé€»è¾‘å®Œå…¨ä¸€è‡´)
          # æ ¼å¼: Name-Tag-Arch[-dependent].exe
          FILE_X64_FULL="$NAME-$TAG-win-x64.exe"
          FILE_X64_LITE="$NAME-$TAG-win-x64-dependent.exe"
          FILE_ARM64_FULL="$NAME-$TAG-win-arm64.exe"
          FILE_ARM64_LITE="$NAME-$TAG-win-arm64-dependent.exe"
          
          # 3. å†™å…¥ Markdown å†…å®¹åˆ°æ–‡ä»¶
          cat <<EOF > release_note.md
          ### ğŸ“¥ ä¸‹è½½æŒ‡å— / Download Guide
          
          è¯·é€‰æ‹©ä½ éœ€è¦çš„ç‰ˆæœ¬ã€‚å¦‚æœä½ ä¸çŸ¥é“è¦ä¸‹è½½å“ªä¸ªï¼Œè¯·ä¸‹è½½ ğŸ‘‰ **[æ¨èç‰ˆæœ¬ (Recommended)]($BASE_URL/$FILE_X64_FULL)** ğŸ‘ˆã€‚
          
          | æ¶æ„ (Arch) | è‡ªåŒ…å« (Self-Contained) <br> *(æ— éœ€è¿è¡Œç¯å¢ƒï¼Œä½“ç§¯ç¨å¤§)* | éè‡ªåŒ…å« (Framework-Dependent) <br> *(éœ€è¦ .NET 10 è¿è¡Œæ—¶ï¼Œä½“ç§¯å°)* |
          | :--- | :---: | :---: |
          | **Windows x64** <br> *(ç»å¤§å¤šæ•°ç”µè„‘)* | [**ä¸‹è½½ / Download**]($BASE_URL/$FILE_X64_FULL) | [ä¸‹è½½ / Download]($BASE_URL/$FILE_X64_LITE) |
          | **Windows ARM64** <br> *(Surface Pro X, Mac VM)* | [**ä¸‹è½½ / Download**]($BASE_URL/$FILE_ARM64_FULL) | [ä¸‹è½½ / Download]($BASE_URL/$FILE_ARM64_LITE) |
          
          ---
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/**/*.exe
          body_path: release_note.md    # ä½¿ç”¨åˆšæ‰ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸ºå†…å®¹
          generate_release_notes: true  # åŒæ—¶ä¼šåœ¨ä¸‹æ–¹è‡ªåŠ¨æ·»åŠ  ChangeLog